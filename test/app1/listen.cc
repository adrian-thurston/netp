#include "main.h"
#include "listen.h"

#include "packet_gen.h"

#include <errno.h>
#include <openssl/bio.h>
#include <openssl/bn.h>
#include <openssl/ssl.h>

#include <sys/socket.h>
#include <arpa/inet.h>

extern const char data[];

void ListenThread::recvShutdown( Shutdown *msg )
{
	log_debug( DBG_THREAD, "received shutdown" );
	breakLoop();
}

void ListenThread::accept( int fd )
{
	log_debug( DBG_THREAD, "accepted connection, starting proxy thread" );

#if 0
	ProxyThread *proxy = new ProxyThread( serverCtx, clientCtx, &contextMap, -1, fd );
	SendsToProxy *sendsToProxy = registerSendsToProxy( proxy );
	proxy->sendsToService = proxy->registerSendsToService( service );

	create( proxy );

	proxySends.push_back( sendsToProxy );
#endif
}

void ListenThread::notifAccept( SelectFd *selectFd )
{
	/* A newly accepted service thread has reading enabled. We don't actually
	 * need it. We just send the current request. */
	selectFd->wantWrite = true;
	selectFd->wantRead = false;
}

void ListenThread::writeReady( SelectFd *fd )
{
	PacketWriter writer( fd->fd );

	BigPacket *msg = BigPacket::open( &writer );
	msg->set_big( &writer, ::data );
	BigPacket::send( &writer );

	fd->wantWrite = false;
	::close( fd->fd );
	selectFdList.detach( fd );
	delete fd;
}


void ListenThread::selectFdReady( SelectFd *fd, uint8_t readyMask )
{
	if ( readyMask & READ_READY ) {
		sockaddr_in peer;
		socklen_t len = sizeof(sockaddr_in);

		int result = ::accept( fd->fd, (sockaddr*)&peer, &len );
		if ( result >= 0 ) {
			accept( result );
		}
		else {
			log_ERROR( "failed to accept connection: " << strerror(errno) );
		}
	}
}

void ListenThread::handleTimer()
{
}

int ListenThread::main()
{
	log_message("starting up" );

	int listenFd = inetListen( 44726 );

	makeNonBlocking( listenFd );

	SelectFd *selectFd = new SelectFd( this, listenFd, 0 );
    selectFd->state = SelectFd::PktListen;
    selectFd->wantRead = true;
    selectFdList.append( selectFd );

	selectLoop();

	::close( listenFd );

	log_message( "exiting" );

	return 0;
}

const char data[] =
"0000000: 2321 202f 6269 6e2f 6261 7368 0a0a 2320\n"
"0000010: 6170 7031 202d 2074 656d 706f 7261 7279\n"
"0000020: 2077 7261 7070 6572 2073 6372 6970 7420\n"
"0000030: 666f 7220 2e6c 6962 732f 6170 7031 0a23\n"
"0000040: 2047 656e 6572 6174 6564 2062 7920 6c69\n"
"0000050: 6274 6f6f 6c20 2847 4e55 206c 6962 746f\n"
"0000060: 6f6c 2920 322e 342e 3220 4465 6269 616e\n"
"0000070: 2d32 2e34 2e32 2d31 2e37 7562 756e 7475\n"
"0000080: 310a 230a 2320 5468 6520 6170 7031 2070\n"
"0000090: 726f 6772 616d 2063 616e 6e6f 7420 6265\n"
"00000a0: 2064 6972 6563 746c 7920 6578 6563 7574\n"
"00000b0: 6564 2075 6e74 696c 2061 6c6c 2074 6865\n"
"00000c0: 206c 6962 746f 6f6c 0a23 206c 6962 7261\n"
"00000d0: 7269 6573 2074 6861 7420 6974 2064 6570\n"
"00000e0: 656e 6473 206f 6e20 6172 6520 696e 7374\n"
"00000f0: 616c 6c65 642e 0a23 0a23 2054 6869 7320\n"
"0000100: 7772 6170 7065 7220 7363 7269 7074 2073\n"
"0000110: 686f 756c 6420 6e65 7665 7220 6265 206d\n"
"0000120: 6f76 6564 206f 7574 206f 6620 7468 6520\n"
"0000130: 6275 696c 6420 6469 7265 6374 6f72 792e\n"
"0000140: 0a23 2049 6620 6974 2069 732c 2069 7420\n"
"0000150: 7769 6c6c 206e 6f74 206f 7065 7261 7465\n"
"0000160: 2063 6f72 7265 6374 6c79 2e0a 0a23 2053\n"
"0000170: 6564 2073 7562 7374 6974 7574 696f 6e20\n"
"0000180: 7468 6174 2068 656c 7073 2075 7320 646f\n"
"0000190: 2072 6f62 7573 7420 7175 6f74 696e 672e\n"
"00001a0: 2020 4974 2062 6163 6b73 6c61 7368 6966\n"
"00001b0: 6965 730a 2320 6d65 7461 6368 6172 6163\n"
"00001c0: 7465 7273 2074 6861 7420 6172 6520 7374\n"
"00001d0: 696c 6c20 6163 7469 7665 2077 6974 6869\n"
"00001e0: 6e20 646f 7562 6c65 2d71 756f 7465 6420\n"
"00001f0: 7374 7269 6e67 732e 0a73 6564 5f71 756f\n"
"0000200: 7465 5f73 7562 7374 3d27 732f 5c28 5b60\n"
"0000210: 2224 5c5c 5d5c 292f 5c5c 5c31 2f67 270a\n"
"0000220: 0a23 2042 6520 426f 7572 6e65 2063 6f6d\n"
"0000230: 7061 7469 626c 650a 6966 2074 6573 7420\n"
"0000240: 2d6e 2022 247b 5a53 485f 5645 5253 494f\n"
"0000250: 4e2b 7365 747d 2220 2626 2028 656d 756c\n"
"0000260: 6174 6520 7368 2920 3e2f 6465 762f 6e75\n"
"0000270: 6c6c 2032 3e26 313b 2074 6865 6e0a 2020\n"
"0000280: 656d 756c 6174 6520 7368 0a20 204e 554c\n"
"0000290: 4c43 4d44 3d3a 0a20 2023 205a 7368 2033\n"
"00002a0: 2e78 2061 6e64 2034 2e78 2070 6572 666f\n"
"00002b0: 726d 7320 776f 7264 2073 706c 6974 7469\n"
"00002c0: 6e67 206f 6e20 247b 312b 2224 4022 7d2c\n"
"00002d0: 2077 6869 6368 0a20 2023 2069 7320 636f\n"
"00002e0: 6e74 7261 7279 2074 6f20 6f75 7220 7573\n"
"00002f0: 6167 652e 2020 4469 7361 626c 6520 7468\n"
"0000300: 6973 2066 6561 7475 7265 2e0a 2020 616c\n"
"0000310: 6961 7320 2d67 2027 247b 312b 2224 4022\n"
"0000320: 7d27 3d27 2224 4022 270a 2020 7365 746f\n"
"0000330: 7074 204e 4f5f 474c 4f42 5f53 5542 5354\n"
"0000340: 0a65 6c73 650a 2020 6361 7365 2060 2873\n"
"0000350: 6574 202d 6f29 2032 3e2f 6465 762f 6e75\n"
"0000360: 6c6c 6020 696e 202a 706f 7369 782a 2920\n"
"0000370: 7365 7420 2d6f 2070 6f73 6978 3b3b 2065\n"
"0000380: 7361 630a 6669 0a42 494e 5f53 483d 7870\n"
"0000390: 6734 3b20 6578 706f 7274 2042 494e 5f53\n"
"00003a0: 4820 2320 666f 7220 5472 7536 340a 4455\n"
"00003b0: 414c 4341 5345 3d31 3b20 6578 706f 7274\n"
"00003c0: 2044 5541 4c43 4153 4520 2320 666f 7220\n"
"00003d0: 4d4b 5320 7368 0a0a 2320 5468 6520 4850\n"
"00003e0: 2d55 5820 6b73 6820 616e 6420 504f 5349\n"
"00003f0: 5820 7368 656c 6c20 7072 696e 7420 7468\n"
"0000400: 6520 7461 7267 6574 2064 6972 6563 746f\n"
"0000410: 7279 2074 6f20 7374 646f 7574 0a23 2069\n"
"0000420: 6620 4344 5041 5448 2069 7320 7365 742e\n"
"0000430: 0a28 756e 7365 7420 4344 5041 5448 2920\n"
"0000440: 3e2f 6465 762f 6e75 6c6c 2032 3e26 3120\n"
"0000450: 2626 2075 6e73 6574 2043 4450 4154 480a\n"
"0000460: 0a72 656c 696e 6b5f 636f 6d6d 616e 643d\n"
"0000470: 2228 6364 202f 686f 6d65 2f74 6875 7273\n"
"0000480: 746f 6e2f 6465 7665 6c2f 6765 6e66 2f74\n"
"0000490: 6573 742f 6170 7031 3b20 7b20 7465 7374\n"
"00004a0: 202d 7a20 5c22 5c24 7b4c 4942 5241 5259\n"
"00004b0: 5f50 4154 482b 7365 747d 5c22 207c 7c20\n"
"00004c0: 756e 7365 7420 4c49 4252 4152 595f 5041\n"
"00004d0: 5448 207c 7c20 7b20 4c49 4252 4152 595f\n"
"00004e0: 5041 5448 3d3b 2065 7870 6f72 7420 4c49\n"
"00004f0: 4252 4152 595f 5041 5448 3b20 7d3b 207d\n"
"0000500: 3b20 7b20 7465 7374 202d 7a20 5c22 5c24\n"
"0000510: 7b43 4f4d 5049 4c45 525f 5041 5448 2b73\n"
"0000520: 6574 7d5c 2220 7c7c 2075 6e73 6574 2043\n"
"0000530: 4f4d 5049 4c45 525f 5041 5448 207c 7c20\n"
"0000540: 7b20 434f 4d50 494c 4552 5f50 4154 483d\n"
"0000550: 3b20 6578 706f 7274 2043 4f4d 5049 4c45\n"
"0000560: 525f 5041 5448 3b20 7d3b 207d 3b20 7b20\n"
"0000570: 7465 7374 202d 7a20 5c22 5c24 7b47 4343\n"
"0000580: 5f45 5845 435f 5052 4546 4958 2b73 6574\n"
"0000590: 7d5c 2220 7c7c 2075 6e73 6574 2047 4343\n"
"00005a0: 5f45 5845 435f 5052 4546 4958 207c 7c20\n"
"00005b0: 7b20 4743 435f 4558 4543 5f50 5245 4649\n"
"00005c0: 583d 3b20 6578 706f 7274 2047 4343 5f45\n"
"00005d0: 5845 435f 5052 4546 4958 3b20 7d3b 207d\n"
"00005e0: 3b20 7b20 7465 7374 202d 7a20 5c22 5c24\n"
"00005f0: 7b4c 445f 5255 4e5f 5041 5448 2b73 6574\n"
"0000600: 7d5c 2220 7c7c 2075 6e73 6574 204c 445f\n"
"0000610: 5255 4e5f 5041 5448 207c 7c20 7b20 4c44\n"
"0000620: 5f52 554e 5f50 4154 483d 3b20 6578 706f\n"
"0000630: 7274 204c 445f 5255 4e5f 5041 5448 3b20\n"
"0000640: 7d3b 207d 3b20 7b20 7465 7374 202d 7a20\n"
"0000650: 5c22 5c24 7b4c 445f 4c49 4252 4152 595f\n"
"0000660: 5041 5448 2b73 6574 7d5c 2220 7c7c 2075\n"
"0000670: 6e73 6574 204c 445f 4c49 4252 4152 595f\n"
"0000680: 5041 5448 207c 7c20 7b20 4c44 5f4c 4942\n"
"0000690: 5241 5259 5f50 4154 483d 3b20 6578 706f\n"
"00006a0: 7274 204c 445f 4c49 4252 4152 595f 5041\n"
"00006b0: 5448 3b20 7d3b 207d 3b20 5041 5448 3d2f\n"
"00006c0: 6f70 742f 636f 6c6d 2f62 696e 3a2f 7573\n"
"00006d0: 722f 6c6f 6361 6c2f 7362 696e 3a2f 7573\n"
"00006e0: 722f 6c6f 6361 6c2f 6269 6e3a 2f75 7372\n"
"00006f0: 2f73 6269 6e3a 2f75 7372 2f62 696e 3a2f\n"
"0000700: 7362 696e 3a2f 6269 6e3a 2f75 7372 2f67\n"
"0000710: 616d 6573 3a2f 7573 722f 6c6f 6361 6c2f\n"
"0000720: 6761 6d65 733b 2065 7870 6f72 7420 5041\n"
"0000730: 5448 3b20 672b 2b20 2d57 616c 6c20 2d67\n"
"0000740: 202d 6f20 5c24 7072 6f67 6469 722f 5c24\n"
"0000750: 6669 6c65 206d 6169 6e2e 6f20 7573 6572\n"
"0000760: 2e6f 206c 6973 7465 6e2e 6f20 6d61 696e\n"
"0000770: 5f67 656e 2e6f 2075 7365 725f 6765 6e2e\n"
"0000780: 6f20 6c69 7374 656e 5f67 656e 2e6f 2069\n"
"0000790: 7471 5f67 656e 2e6f 2070 6163 6b65 745f\n"
"00007a0: 6765 6e2e 6f20 202d 4c2f 686f 6d65 2f74\n"
"00007b0: 6875 7273 746f 6e2f 6465 7665 6c2f 6765\n"
"00007c0: 6e66 2f74 6573 742f 2e2e 2f73 7263 2f2e\n"
"00007d0: 6c69 6273 202f 686f 6d65 2f74 6875 7273\n"
"00007e0: 746f 6e2f 6465 7665 6c2f 6765 6e66 2f74\n"
"00007f0: 6573 742f 2e2e 2f73 7263 2f2e 6c69 6273\n"
"0000800: 2f6c 6962 6765 6e66 2e73 6f20 2d6c 6361\n"
"0000810: 7265 7320 2d6c 6372 7970 746f 202d 6c73\n"
"0000820: 736c 202d 6c70 7468 7265 6164 202d 576c\n"
"0000830: 2c2d 7270 6174 6820 2d57 6c2c 2f68 6f6d\n"
"0000840: 652f 7468 7572 7374 6f6e 2f64 6576 656c\n"
"0000850: 2f67 656e 662f 7465 7374 2f2e 2e2f 7372\n"
"0000860: 632f 2e6c 6962 7320 2d57 6c2c 2d72 7061\n"
"0000870: 7468 202d 576c 2c2f 686f 6d65 2f74 6875\n"
"0000880: 7273 746f 6e2f 706b 6773 2f67 656e 662f\n"
"0000890: 6c69 6229 220a 0a23 2054 6869 7320 656e\n"
"00008a0: 7669 726f 6e6d 656e 7420 7661 7269 6162\n"
"00008b0: 6c65 2064 6574 6572 6d69 6e65 7320 6f75\n"
"00008c0: 7220 6f70 6572 6174 696f 6e20 6d6f 6465\n"
"00008d0: 2e0a 6966 2074 6573 7420 2224 6c69 6274\n"
"00008e0: 6f6f 6c5f 696e 7374 616c 6c5f 6d61 6769\n"
"00008f0: 6322 203d 2022 2525 254d 4147 4943 2076\n"
"0000900: 6172 6961 626c 6525 2525 223b 2074 6865\n"
"0000910: 6e0a 2020 2320 696e 7374 616c 6c20 6d6f\n"
"0000920: 6465 206e 6565 6473 2074 6865 2066 6f6c\n"
"0000930: 6c6f 7769 6e67 2076 6172 6961 626c 6573\n"
"0000940: 3a0a 2020 6765 6e65 7261 7465 645f 6279\n"
"0000950: 5f6c 6962 746f 6f6c 5f76 6572 7369 6f6e\n"
"0000960: 3d27 322e 342e 3227 0a20 206e 6f74 696e\n"
"0000970: 7374 5f64 6570 6c69 6273 3d27 202f 686f\n"
"0000980: 6d65 2f74 6875 7273 746f 6e2f 6465 7665\n"
"0000990: 6c2f 6765 6e66 2f74 6573 742f 2e2e 2f73\n"
"00009a0: 7263 2f2e 6c69 6273 2f6c 6962 6765 6e66\n"
"00009b0: 2e6c 6127 0a65 6c73 650a 2020 2320 5768\n"
"00009c0: 656e 2077 6520 6172 6520 736f 7572 6365\n"
"00009d0: 6420 696e 2065 7865 6375 7465 206d 6f64\n"
"00009e0: 652c 2024 6669 6c65 2061 6e64 2024 4543\n"
"00009f0: 484f 2061 7265 2061 6c72 6561 6479 2073\n"
"0000a00: 6574 2e0a 2020 6966 2074 6573 7420 2224\n"
"0000a10: 6c69 6274 6f6f 6c5f 6578 6563 7574 655f\n"
"0000a20: 6d61 6769 6322 2021 3d20 2225 2525 4d41\n"
"0000a30: 4749 4320 7661 7269 6162 6c65 2525 2522\n"
"0000a40: 3b20 7468 656e 0a20 2020 2066 696c 653d\n"
"0000a50: 2224 3022 0a0a 2320 4120 6675 6e63 7469\n"
"0000a60: 6f6e 2074 6861 7420 6973 2075 7365 6420\n"
"0000a70: 7768 656e 2074 6865 7265 2069 7320 6e6f\n"
"0000a80: 2070 7269 6e74 2062 7569 6c74 696e 206f\n"
"0000a90: 7220 7072 696e 7466 2e0a 6675 6e63 5f66\n"
"0000aa0: 616c 6c62 6163 6b5f 6563 686f 2028 290a\n"
"0000ab0: 7b0a 2020 6576 616c 2027 6361 7420 3c3c\n"
"0000ac0: 5f4c 5445 4348 4f5f 454f 460a 2431 0a5f\n"
"0000ad0: 4c54 4543 484f 5f45 4f46 270a 7d0a 2020\n"
"0000ae0: 2020 4543 484f 3d22 7072 696e 7466 2025\n"
"0000af0: 735c 5c6e 220a 2020 6669 0a0a 2320 5665\n"
"0000b00: 7279 2062 6173 6963 206f 7074 696f 6e20\n"
"0000b10: 7061 7273 696e 672e 2054 6865 7365 206f\n"
"0000b20: 7074 696f 6e73 2061 7265 2028 6129 2073\n"
"0000b30: 7065 6369 6669 6320 746f 0a23 2074 6865\n"
"0000b40: 206c 6962 746f 6f6c 2077 7261 7070 6572\n"
"0000b50: 2c20 2862 2920 6172 6520 6964 656e 7469\n"
"0000b60: 6361 6c20 6265 7477 6565 6e20 7468 6520\n"
"0000b70: 7772 6170 7065 720a 2320 2f73 6372 6970\n"
"0000b80: 742f 2061 6e64 2074 6865 2077 7261 7070\n"
"0000b90: 6572 202f 6578 6563 7574 6162 6c65 2f20\n"
"0000ba0: 7768 6963 6820 6973 2075 7365 6420 6f6e\n"
"0000bb0: 6c79 206f 6e0a 2320 7769 6e64 6f77 7320\n"
"0000bc0: 706c 6174 666f 726d 732c 2061 6e64 2028\n"
"0000bd0: 6329 2061 6c6c 2062 6567 696e 2077 6974\n"
"0000be0: 6820 7468 6520 7374 7269 6e67 202d 2d6c\n"
"0000bf0: 742d 0a23 2028 6170 706c 6963 6174 696f\n"
"0000c00: 6e20 7072 6f67 7261 6d73 2061 7265 2075\n"
"0000c10: 6e6c 696b 656c 7920 746f 2068 6176 6520\n"
"0000c20: 6f70 7469 6f6e 7320 7768 6963 6820 6d61\n"
"0000c30: 7463 680a 2320 7468 6973 2070 6174 7465\n"
"0000c40: 726e 292e 0a23 0a23 2054 6865 7265 2061\n"
"0000c50: 7265 206f 6e6c 7920 7477 6f20 7375 7070\n"
"0000c60: 6f72 7465 6420 6f70 7469 6f6e 733a 202d\n"
"0000c70: 2d6c 742d 6465 6275 6720 616e 640a 2320\n"
"0000c80: 2d2d 6c74 2d64 756d 702d 7363 7269 7074\n"
"0000c90: 2e20 5468 6572 6520 6973 2c20 6465 6c69\n"
"0000ca0: 6265 7261 7465 6c79 2c20 6e6f 202d 2d6c\n"
"0000cb0: 742d 6865 6c70 2e0a 230a 2320 5468 6520\n"
"0000cc0: 6669 7273 7420 6172 6775 6d65 6e74 2074\n"
"0000cd0: 6f20 7468 6973 2070 6172 7369 6e67 2066\n"
"0000ce0: 756e 6374 696f 6e20 7368 6f75 6c64 2062\n"
"0000cf0: 6520 7468 650a 2320 7363 7269 7074 2773\n"
"0000d00: 202e 2e2f 6c69 6274 6f6f 6c20 7661 6c75\n"
"0000d10: 652c 2066 6f6c 6c6f 7765 6420 6279 206e\n"
"0000d20: 6f2e 0a6c 745f 6f70 7469 6f6e 5f64 6562\n"
"0000d30: 7567 3d0a 6675 6e63 5f70 6172 7365 5f6c\n"
"0000d40: 745f 6f70 7469 6f6e 7320 2829 0a7b 0a20\n"
"0000d50: 206c 745f 7363 7269 7074 5f61 7267 303d\n"
"0000d60: 2430 0a20 2073 6869 6674 0a20 2066 6f72\n"
"0000d70: 206c 745f 6f70 740a 2020 646f 0a20 2020\n"
"0000d80: 2063 6173 6520 2224 6c74 5f6f 7074 2220\n"
"0000d90: 696e 0a20 2020 202d 2d6c 742d 6465 6275\n"
"0000da0: 6729 206c 745f 6f70 7469 6f6e 5f64 6562\n"
"0000db0: 7567 3d31 203b 3b0a 2020 2020 2d2d 6c74\n"
"0000dc0: 2d64 756d 702d 7363 7269 7074 290a 2020\n"
"0000dd0: 2020 2020 2020 6c74 5f64 756d 705f 443d\n"
"0000de0: 6024 4543 484f 2022 5824 6c74 5f73 6372\n"
"0000df0: 6970 745f 6172 6730 2220 7c20 2f62 696e\n"
"0000e00: 2f73 6564 202d 6520 2773 2f5e 582f 2f27\n"
"0000e10: 202d 6520 2773 252f 5b5e 2f5d 2a24 2525\n"
"0000e20: 2760 0a20 2020 2020 2020 2074 6573 7420\n"
"0000e30: 2258 246c 745f 6475 6d70 5f44 2220 3d20\n"
"0000e40: 2258 246c 745f 7363 7269 7074 5f61 7267\n"
"0000e50: 3022 2026 2620 6c74 5f64 756d 705f 443d\n"
"0000e60: 2e0a 2020 2020 2020 2020 6c74 5f64 756d\n"
"0000e70: 705f 463d 6024 4543 484f 2022 5824 6c74\n"
"0000e80: 5f73 6372 6970 745f 6172 6730 2220 7c20\n"
"0000e90: 2f62 696e 2f73 6564 202d 6520 2773 2f5e\n"
"0000ea0: 582f 2f27 202d 6520 2773 255e 2e2a 2f25\n"
"0000eb0: 2527 600a 2020 2020 2020 2020 6361 7420\n"
"0000ec0: 2224 6c74 5f64 756d 705f 442f 246c 745f\n"
"0000ed0: 6475 6d70 5f46 220a 2020 2020 2020 2020\n"
"0000ee0: 6578 6974 2030 0a20 2020 2020 203b 3b0a\n"
"0000ef0: 2020 2020 2d2d 6c74 2d2a 290a 2020 2020\n"
"0000f00: 2020 2020 2445 4348 4f20 2255 6e72 6563\n"
"0000f10: 6f67 6e69 7a65 6420 2d2d 6c74 2d20 6f70\n"
"0000f20: 7469 6f6e 3a20 2724 6c74 5f6f 7074 2722\n"
"0000f30: 2031 3e26 320a 2020 2020 2020 2020 6578\n"
"0000f40: 6974 2031 0a20 2020 2020 203b 3b0a 2020\n"
"0000f50: 2020 6573 6163 0a20 2064 6f6e 650a 0a20\n"
"0000f60: 2023 2050 7269 6e74 2074 6865 2064 6562\n"
"0000f70: 7567 2062 616e 6e65 7220 696d 6d65 6469\n"
"0000f80: 6174 656c 793a 0a20 2069 6620 7465 7374\n"
"0000f90: 202d 6e20 2224 6c74 5f6f 7074 696f 6e5f\n"
"0000fa0: 6465 6275 6722 3b20 7468 656e 0a20 2020\n"
"0000fb0: 2065 6368 6f20 2261 7070 313a 6170 7031\n"
"0000fc0: 3a24 7b4c 494e 454e 4f7d 3a20 6c69 6274\n"
"0000fd0: 6f6f 6c20 7772 6170 7065 7220 2847 4e55\n"
"0000fe0: 206c 6962 746f 6f6c 2920 322e 342e 3220\n"
"0000ff0: 4465 6269 616e 2d32 2e34 2e32 2d31 2e37\n"
"0001000: 7562 756e 7475 3122 2031 3e26 320a 2020\n"
"0001010: 6669 0a7d 0a0a 2320 5573 6564 2077 6865\n"
"0001020: 6e20 2d2d 6c74 2d64 6562 7567 2e20 5072\n"
"0001030: 696e 7473 2069 7473 2061 7267 756d 656e\n"
"0001040: 7473 2074 6f20 7374 646f 7574 0a23 2028\n"
"0001050: 7265 6469 7265 6374 696f 6e20 6973 2074\n"
"0001060: 6865 2072 6573 706f 6e73 6962 696c 6974\n"
"0001070: 7920 6f66 2074 6865 2063 616c 6c65 7229\n"
"0001080: 0a66 756e 635f 6c74 5f64 756d 705f 6172\n"
"0001090: 6773 2028 290a 7b0a 2020 6c74 5f64 756d\n"
"00010a0: 705f 6172 6773 5f4e 3d31 3b0a 2020 666f\n"
"00010b0: 7220 6c74 5f61 7267 0a20 2064 6f0a 2020\n"
"00010c0: 2020 2445 4348 4f20 2261 7070 313a 6170\n"
"00010d0: 7031 3a24 7b4c 494e 454e 4f7d 3a20 6e65\n"
"00010e0: 7761 7267 765b 246c 745f 6475 6d70 5f61\n"
"00010f0: 7267 735f 4e5d 3a20 246c 745f 6172 6722\n"
"0001100: 0a20 2020 206c 745f 6475 6d70 5f61 7267\n"
"0001110: 735f 4e3d 6065 7870 7220 246c 745f 6475\n"
"0001120: 6d70 5f61 7267 735f 4e20 2b20 3160 0a20\n"
"0001130: 2064 6f6e 650a 7d0a 0a23 2043 6f72 6520\n"
"0001140: 6675 6e63 7469 6f6e 2066 6f72 206c 6175\n"
"0001150: 6e63 6869 6e67 2074 6865 2074 6172 6765\n"
"0001160: 7420 6170 706c 6963 6174 696f 6e0a 6675\n"
"0001170: 6e63 5f65 7865 635f 7072 6f67 7261 6d5f\n"
"0001180: 636f 7265 2028 290a 7b0a 0a20 2020 2020\n"
"0001190: 2069 6620 7465 7374 202d 6e20 2224 6c74\n"
"00011a0: 5f6f 7074 696f 6e5f 6465 6275 6722 3b20\n"
"00011b0: 7468 656e 0a20 2020 2020 2020 2024 4543\n"
"00011c0: 484f 2022 6170 7031 3a61 7070 313a 247b\n"
"00011d0: 4c49 4e45 4e4f 7d3a 206e 6577 6172 6776\n"
"00011e0: 5b30 5d3a 2024 7072 6f67 6469 722f 2470\n"
"00011f0: 726f 6772 616d 2220 313e 2632 0a20 2020\n"
"0001200: 2020 2020 2066 756e 635f 6c74 5f64 756d\n"
"0001210: 705f 6172 6773 2024 7b31 2b22 2440 227d\n"
"0001220: 2031 3e26 320a 2020 2020 2020 6669 0a20\n"
"0001230: 2020 2020 2065 7865 6320 2224 7072 6f67\n"
"0001240: 6469 722f 2470 726f 6772 616d 2220 247b\n"
"0001250: 312b 2224 4022 7d0a 0a20 2020 2020 2024\n"
"0001260: 4543 484f 2022 2430 3a20 6361 6e6e 6f74\n"
"0001270: 2065 7865 6320 2470 726f 6772 616d 2024\n"
"0001280: 2a22 2031 3e26 320a 2020 2020 2020 6578\n"
"0001290: 6974 2031 0a7d 0a0a 2320 4120 6675 6e63\n"
"00012a0: 7469 6f6e 2074 6f20 656e 6361 7073 756c\n"
"00012b0: 6174 6520 6c61 756e 6368 696e 6720 7468\n"
"00012c0: 6520 7461 7267 6574 2061 7070 6c69 6361\n"
"00012d0: 7469 6f6e 0a23 2053 7472 6970 7320 6f70\n"
"00012e0: 7469 6f6e 7320 696e 2074 6865 202d 2d6c\n"
"00012f0: 742d 2a20 6e61 6d65 7370 6163 6520 6672\n"
"0001300: 6f6d 2024 4020 616e 640a 2320 6c61 756e\n"
"0001310: 6368 6573 2074 6172 6765 7420 6170 706c\n"
"0001320: 6963 6174 696f 6e20 7769 7468 2074 6865\n"
"0001330: 2072 656d 6169 6e69 6e67 2061 7267 756d\n"
"0001340: 656e 7473 2e0a 6675 6e63 5f65 7865 635f\n"
"0001350: 7072 6f67 7261 6d20 2829 0a7b 0a20 2063\n"
"0001360: 6173 6520 2220 242a 2022 2069 6e0a 2020\n"
"0001370: 2a5c 202d 2d6c 742d 2a29 0a20 2020 2066\n"
"0001380: 6f72 206c 745f 7772 5f61 7267 0a20 2020\n"
"0001390: 2064 6f0a 2020 2020 2020 6361 7365 2024\n"
"00013a0: 6c74 5f77 725f 6172 6720 696e 0a20 2020\n"
"00013b0: 2020 202d 2d6c 742d 2a29 203b 3b0a 2020\n"
"00013c0: 2020 2020 2a29 2073 6574 2078 2022 2440\n"
"00013d0: 2220 2224 6c74 5f77 725f 6172 6722 3b20\n"
"00013e0: 7368 6966 743b 3b0a 2020 2020 2020 6573\n"
"00013f0: 6163 0a20 2020 2020 2073 6869 6674 0a20\n"
"0001400: 2020 2064 6f6e 6520 3b3b 0a20 2065 7361\n"
"0001410: 630a 2020 6675 6e63 5f65 7865 635f 7072\n"
"0001420: 6f67 7261 6d5f 636f 7265 2024 7b31 2b22\n"
"0001430: 2440 227d 0a7d 0a0a 2020 2320 5061 7273\n"
"0001440: 6520 6f70 7469 6f6e 730a 2020 6675 6e63\n"
"0001450: 5f70 6172 7365 5f6c 745f 6f70 7469 6f6e\n"
"0001460: 7320 2224 3022 2024 7b31 2b22 2440 227d\n"
"0001470: 0a0a 2020 2320 4669 6e64 2074 6865 2064\n"
"0001480: 6972 6563 746f 7279 2074 6861 7420 7468\n"
"0001490: 6973 2073 6372 6970 7420 6c69 7665 7320\n"
"00014a0: 696e 2e0a 2020 7468 6973 6469 723d 6024\n"
"00014b0: 4543 484f 2022 2466 696c 6522 207c 202f\n"
"00014c0: 6269 6e2f 7365 6420 2773 252f 5b5e 2f5d\n"
"00014d0: 2a24 2525 2760 0a20 2074 6573 7420 2278\n"
"00014e0: 2474 6869 7364 6972 2220 3d20 2278 2466\n"
"00014f0: 696c 6522 2026 2620 7468 6973 6469 723d\n"
"0001500: 2e0a 0a20 2023 2046 6f6c 6c6f 7720 7379\n"
"0001510: 6d62 6f6c 6963 206c 696e 6b73 2075 6e74\n"
"0001520: 696c 2077 6520 6765 7420 746f 2074 6865\n"
"0001530: 2072 6561 6c20 7468 6973 6469 722e 0a20\n"
"0001540: 2066 696c 653d 606c 7320 2d6c 6420 2224\n"
"0001550: 6669 6c65 2220 7c20 2f62 696e 2f73 6564\n"
"0001560: 202d 6e20 2773 2f2e 2a2d 3e20 2f2f 7027\n"
"0001570: 600a 2020 7768 696c 6520 7465 7374 202d\n"
"0001580: 6e20 2224 6669 6c65 223b 2064 6f0a 2020\n"
"0001590: 2020 6465 7374 6469 723d 6024 4543 484f\n"
"00015a0: 2022 2466 696c 6522 207c 202f 6269 6e2f\n"
"00015b0: 7365 6420 2773 252f 5b5e 2f5d 2a24 2525\n"
"00015c0: 2760 0a0a 2020 2020 2320 4966 2074 6865\n"
"00015d0: 7265 2077 6173 2061 2064 6972 6563 746f\n"
"00015e0: 7279 2063 6f6d 706f 6e65 6e74 2c20 7468\n"
"00015f0: 656e 2063 6861 6e67 6520 7468 6973 6469\n"
"0001600: 722e 0a20 2020 2069 6620 7465 7374 2022\n"
"0001610: 7824 6465 7374 6469 7222 2021 3d20 2278\n"
"0001620: 2466 696c 6522 3b20 7468 656e 0a20 2020\n"
"0001630: 2020 2063 6173 6520 2224 6465 7374 6469\n"
"0001640: 7222 2069 6e0a 2020 2020 2020 5b5c 5c2f\n"
"0001650: 5d2a 207c 205b 412d 5a61 2d7a 5d3a 5b5c\n"
"0001660: 5c2f 5d2a 2920 7468 6973 6469 723d 2224\n"
"0001670: 6465 7374 6469 7222 203b 3b0a 2020 2020\n"
"0001680: 2020 2a29 2074 6869 7364 6972 3d22 2474\n"
"0001690: 6869 7364 6972 2f24 6465 7374 6469 7222\n"
"00016a0: 203b 3b0a 2020 2020 2020 6573 6163 0a20\n"
"00016b0: 2020 2066 690a 0a20 2020 2066 696c 653d\n"
"00016c0: 6024 4543 484f 2022 2466 696c 6522 207c\n"
"00016d0: 202f 6269 6e2f 7365 6420 2773 255e 2e2a\n"
"00016e0: 2f25 2527 600a 2020 2020 6669 6c65 3d60\n"
"00016f0: 6c73 202d 6c64 2022 2474 6869 7364 6972\n"
"0001700: 2f24 6669 6c65 2220 7c20 2f62 696e 2f73\n"
"0001710: 6564 202d 6e20 2773 2f2e 2a2d 3e20 2f2f\n"
"0001720: 7027 600a 2020 646f 6e65 0a0a 2020 2320\n"
"0001730: 5573 7561 6c6c 7920 276e 6f27 2c20 6578\n"
"0001740: 6365 7074 206f 6e20 6379 6777 696e 2f6d\n"
"0001750: 696e 6777 2077 6865 6e20 656d 6265 6464\n"
"0001760: 6564 2069 6e74 6f0a 2020 2320 7468 6520\n"
"0001770: 6377 7261 7070 6572 2e0a 2020 5752 4150\n"
"0001780: 5045 525f 5343 5249 5054 5f42 454c 4f4e\n"
"0001790: 4753 5f49 4e5f 4f42 4a44 4952 3d6e 6f0a\n"
"00017a0: 2020 6966 2074 6573 7420 2224 5752 4150\n"
"00017b0: 5045 525f 5343 5249 5054 5f42 454c 4f4e\n"
"00017c0: 4753 5f49 4e5f 4f42 4a44 4952 2220 3d20\n"
"00017d0: 2279 6573 223b 2074 6865 6e0a 2020 2020\n"
"00017e0: 2320 7370 6563 6961 6c20 6361 7365 2066\n"
"00017f0: 6f72 2027 2e27 0a20 2020 2069 6620 7465\n"
"0001800: 7374 2022 2474 6869 7364 6972 2220 3d20\n"
"0001810: 222e 223b 2074 6865 6e0a 2020 2020 2020\n"
"0001820: 7468 6973 6469 723d 6070 7764 600a 2020\n"
"0001830: 2020 6669 0a20 2020 2023 2072 656d 6f76\n"
"0001840: 6520 2e6c 6962 7320 6672 6f6d 2074 6869\n"
"0001850: 7364 6972 0a20 2020 2063 6173 6520 2224\n"
"0001860: 7468 6973 6469 7222 2069 6e0a 2020 2020\n"
"0001870: 2a5b 5c5c 2f5d 2e6c 6962 7320 2920 7468\n"
"0001880: 6973 6469 723d 6024 4543 484f 2022 2474\n"
"0001890: 6869 7364 6972 2220 7c20 2f62 696e 2f73\n"
"00018a0: 6564 2027 7325 5b5c 5c2f 5d5b 5e5c 5c2f\n"
"00018b0: 5d2a 2425 2527 6020 3b3b 0a20 2020 202e\n"
"00018c0: 6c69 6273 2029 2020 2074 6869 7364 6972\n"
"00018d0: 3d2e 203b 3b0a 2020 2020 6573 6163 0a20\n"
"00018e0: 2066 690a 0a20 2023 2054 7279 2074 6f20\n"
"00018f0: 6765 7420 7468 6520 6162 736f 6c75 7465\n"
"0001900: 2064 6972 6563 746f 7279 206e 616d 652e\n"
"0001910: 0a20 2061 6273 6469 723d 6063 6420 2224\n"
"0001920: 7468 6973 6469 7222 2026 2620 7077 6460\n"
"0001930: 0a20 2074 6573 7420 2d6e 2022 2461 6273\n"
"0001940: 6469 7222 2026 2620 7468 6973 6469 723d\n"
"0001950: 2224 6162 7364 6972 220a 0a20 2070 726f\n"
"0001960: 6772 616d 3d6c 742d 2761 7070 3127 0a20\n"
"0001970: 2070 726f 6764 6972 3d22 2474 6869 7364\n"
"0001980: 6972 2f2e 6c69 6273 220a 0a20 2069 6620\n"
"0001990: 7465 7374 2021 202d 6620 2224 7072 6f67\n"
"00019a0: 6469 722f 2470 726f 6772 616d 2220 7c7c\n"
"00019b0: 0a20 2020 2020 7b20 6669 6c65 3d60 6c73\n"
"00019c0: 202d 3164 7420 2224 7072 6f67 6469 722f\n"
"00019d0: 2470 726f 6772 616d 2220 2224 7072 6f67\n"
"00019e0: 6469 722f 2e2e 2f24 7072 6f67 7261 6d22\n"
"00019f0: 2032 3e2f 6465 762f 6e75 6c6c 207c 202f\n"
"0001a00: 6269 6e2f 7365 6420 3171 603b 205c 0a20\n"
"0001a10: 2020 2020 2020 7465 7374 2022 5824 6669\n"
"0001a20: 6c65 2220 213d 2022 5824 7072 6f67 6469\n"
"0001a30: 722f 2470 726f 6772 616d 223b 207d 3b20\n"
"0001a40: 7468 656e 0a0a 2020 2020 6669 6c65 3d22\n"
"0001a50: 2424 2d24 7072 6f67 7261 6d22 0a0a 2020\n"
"0001a60: 2020 6966 2074 6573 7420 2120 2d64 2022\n"
"0001a70: 2470 726f 6764 6972 223b 2074 6865 6e0a\n"
"0001a80: 2020 2020 2020 6d6b 6469 7220 2224 7072\n"
"0001a90: 6f67 6469 7222 0a20 2020 2065 6c73 650a\n"
"0001aa0: 2020 2020 2020 726d 202d 6620 2224 7072\n"
"0001ab0: 6f67 6469 722f 2466 696c 6522 0a20 2020\n"
"0001ac0: 2066 690a 0a20 2020 2023 2072 656c 696e\n"
"0001ad0: 6b20 6578 6563 7574 6162 6c65 2069 6620\n"
"0001ae0: 6e65 6365 7373 6172 790a 2020 2020 6966\n"
"0001af0: 2074 6573 7420 2d6e 2022 2472 656c 696e\n"
"0001b00: 6b5f 636f 6d6d 616e 6422 3b20 7468 656e\n"
"0001b10: 0a20 2020 2020 2069 6620 7265 6c69 6e6b\n"
"0001b20: 5f63 6f6d 6d61 6e64 5f6f 7574 7075 743d\n"
"0001b30: 6065 7661 6c20 2472 656c 696e 6b5f 636f\n"
"0001b40: 6d6d 616e 6420 323e 2631 603b 2074 6865\n"
"0001b50: 6e20 3a0a 2020 2020 2020 656c 7365 0a09\n"
"0001b60: 7072 696e 7466 2025 735c 6e20 2224 7265\n"
"0001b70: 6c69 6e6b 5f63 6f6d 6d61 6e64 5f6f 7574\n"
"0001b80: 7075 7422 203e 2632 0a09 726d 202d 6620\n"
"0001b90: 2224 7072 6f67 6469 722f 2466 696c 6522\n"
"0001ba0: 0a09 6578 6974 2031 0a20 2020 2020 2066\n"
"0001bb0: 690a 2020 2020 6669 0a0a 2020 2020 6d76\n"
"0001bc0: 202d 6620 2224 7072 6f67 6469 722f 2466\n"
"0001bd0: 696c 6522 2022 2470 726f 6764 6972 2f24\n"
"0001be0: 7072 6f67 7261 6d22 2032 3e2f 6465 762f\n"
"0001bf0: 6e75 6c6c 207c 7c0a 2020 2020 7b20 726d\n"
"0001c00: 202d 6620 2224 7072 6f67 6469 722f 2470\n"
"0001c10: 726f 6772 616d 223b 0a20 2020 2020 206d\n"
"0001c20: 7620 2d66 2022 2470 726f 6764 6972 2f24\n"
"0001c30: 6669 6c65 2220 2224 7072 6f67 6469 722f\n"
"0001c40: 2470 726f 6772 616d 223b 207d 0a20 2020\n"
"0001c50: 2072 6d20 2d66 2022 2470 726f 6764 6972\n"
"0001c60: 2f24 6669 6c65 220a 2020 6669 0a0a 2020\n"
"0001c70: 6966 2074 6573 7420 2d66 2022 2470 726f\n"
"0001c80: 6764 6972 2f24 7072 6f67 7261 6d22 3b20\n"
"0001c90: 7468 656e 0a20 2020 2069 6620 7465 7374\n"
"0001ca0: 2022 246c 6962 746f 6f6c 5f65 7865 6375\n"
"0001cb0: 7465 5f6d 6167 6963 2220 213d 2022 2525\n"
"0001cc0: 254d 4147 4943 2076 6172 6961 626c 6525\n"
"0001cd0: 2525 223b 2074 6865 6e0a 2020 2020 2020\n"
"0001ce0: 2320 5275 6e20 7468 6520 6163 7475 616c\n"
"0001cf0: 2070 726f 6772 616d 2077 6974 6820 6f75\n"
"0001d00: 7220 6172 6775 6d65 6e74 732e 0a20 2020\n"
"0001d10: 2020 2066 756e 635f 6578 6563 5f70 726f\n"
"0001d20: 6772 616d 2024 7b31 2b22 2440 227d 0a20\n"
"0001d30: 2020 2066 690a 2020 656c 7365 0a20 2020\n"
"0001d40: 2023 2054 6865 2070 726f 6772 616d 2064\n"
"0001d50: 6f65 736e 2774 2065 7869 7374 2e0a 2020\n"
"0001d60: 2020 2445 4348 4f20 2224 303a 2065 7272\n"
"0001d70: 6f72 3a20 5c60 2470 726f 6764 6972 2f24\n"
"0001d80: 7072 6f67 7261 6d27 2064 6f65 7320 6e6f\n"
"0001d90: 7420 6578 6973 7422 2031 3e26 320a 2020\n"
"0001da0: 2020 2445 4348 4f20 2254 6869 7320 7363\n"
"0001db0: 7269 7074 2069 7320 6a75 7374 2061 2077\n"
"0001dc0: 7261 7070 6572 2066 6f72 2024 7072 6f67\n"
"0001dd0: 7261 6d2e 2220 313e 2632 0a20 2020 2024\n"
"0001de0: 4543 484f 2022 5365 6520 7468 6520 6c69\n"
"0001df0: 6274 6f6f 6c20 646f 6375 6d65 6e74 6174\n"
"0001e00: 696f 6e20 666f 7220 6d6f 7265 2069 6e66\n"
"0001e10: 6f72 6d61 7469 6f6e 2e22 2031 3e26 320a\n"
"0001e20: 2020 2020 6578 6974 2031 0a20 2066 690a\n"
"0001e30: 6669 0a\n";
